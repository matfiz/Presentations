<!doctype html>  
<html>
  <head>
    <meta charset="utf-8">
    <title>Goliath</title>
      <link rel="stylesheet" href="../css/reset.css">
      <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/pygments/colorful.css">
  </head>
  <body>
    <div id="main">
        <section id="section-0">
            <section id="slide-0-0" class="">
              <h1>Goliath</h1>

<h2>and its friends</h2>

<ul>
<li>Rack</li>
<li>Fiber</li>
<li>EventMachine</li>
<li>EM-Synchrony</li>
</ul>

            </section>
            <section id="slide-0-1" class="">
              <h1>Bruno Michel</h1>

<ul>
<li>Lead Dev at <a href="http://dev.af83.com/">af83</a></li>
<li>Developer of <a href="http://linuxfr.org/">LinuxFr.org</a></li>
<li>President of <a href="http://www.rubyfrance.org/">Ruby France</a></li>
<li><a href="https://github.com/nono">github.com/nono</a></li>
<li><a href="https://twitter.com/brmichel">twitter.com/brmichel</a></li>
</ul>

            </section>
            <section id="slide-0-2" class="">
              <h1>Goliath</h1>

<ul>
<li>Web server / framework</li>
<li>Asynchronous</li>
<li>Ruby</li>
<li>Open Source</li>
<li>Made by Postrank</li>
</ul>

            </section>
        </section>
        <section id="section-1">
            <section id="slide-1-0" class="">
              <h1>demo</h1>

            </section>
        </section>
        <section id="section-2">
            <section id="slide-2-0" class="">
              <h1>EventMachine</h1>

<ul>
<li>Ruby Framework Ruby</li>
<li>Evented</li>
<li>Network drivers

<ul>
<li>(HTTP, mysql, redis, MongoDB, SMTP, XMPP and many more)</li>
</ul></li>
</ul>

            </section>
            <section id="slide-2-1" class="">
              <h1>3 ways to handle requests</h1>

<ul>
<li>1 process per connection</li>
<li>1 thread  per connection</li>
<li>Evented programming</li>
</ul>

            </section>
            <section id="slide-2-2" class="">
              <h1>em-example</h1>

<p><pre><code class="ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>

<span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
  <span class="no">EM</span><span class="o">.</span><span class="n">add_periodic_timer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;Working&quot;</span> <span class="p">}</span>
  <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="no">EM</span><span class="o">.</span><span class="n">stop_event_loop</span> <span class="p">}</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s2">&quot;Done&quot;</span>
</code></pre></p>

            </section>
            <section id="slide-2-3" class="">
              <h1>Warning</h1>

<ul>
<li>Don't block the event loop for too long</li>
<li>Split your task with <code>EM.next_tick</code></li>
</ul>

            </section>
        </section>
        <section id="section-3">
            <section id="slide-3-0" class="">
              <h1>Ruby 1.9 and Fibers</h1>

<p><pre><code class="ruby"><span class="k">def</span> <span class="nf">async_fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="no">Fiber</span><span class="o">.</span><span class="n">current</span>
  <span class="n">http</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
  <span class="n">http</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span> <span class="n">f</span><span class="o">.</span><span class="n">resume</span><span class="p">(</span><span class="n">http</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">return</span> <span class="no">Fiber</span><span class="o">.</span><span class="n">yield</span>
<span class="k">end</span>
<span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
  <span class="no">Fiber</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">async_fetch</span><span class="p">(</span><span class="s1">&#39;http://linuxfr.org/&#39;</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">&quot;Fetched page #1: </span><span class="si">#{</span><span class="n">data</span><span class="o">.</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="p">}</span><span class="o">.</span><span class="n">resume</span>
<span class="k">end</span>
</code></pre></p>

            </section>
            <section id="slide-3-1" class="">
              <h1>EM-Synchrony: example</h1>

<p><pre><code class="ruby"><span class="no">EM</span><span class="o">.</span><span class="n">synchrony</span> <span class="k">do</span>
  <span class="no">HR</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span>
  <span class="n">m</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">Synchrony</span><span class="o">::</span><span class="no">Multi</span><span class="o">.</span><span class="n">new</span>
  <span class="n">m</span><span class="o">.</span><span class="n">add</span> <span class="ss">:page1</span><span class="p">,</span> <span class="no">HR</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;http://foo.com/1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">aget</span>
  <span class="n">m</span><span class="o">.</span><span class="n">add</span> <span class="ss">:page2</span><span class="p">,</span> <span class="no">HR</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;http://foo.com/2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">aget</span>
  <span class="n">m</span><span class="o">.</span><span class="n">add</span> <span class="ss">:page3</span><span class="p">,</span> <span class="no">HR</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;http://foo.com/3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">aget</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">perform</span><span class="o">.</span><span class="n">responses</span><span class="o">[</span><span class="ss">:callback</span><span class="o">].</span><span class="n">values</span>
<span class="k">end</span>
</code></pre></p>

            </section>
            <section id="slide-3-2" class="">
              <h1>EM-Synchrony: example</h1>

<p><pre><code class="ruby"><span class="no">EM</span><span class="o">.</span><span class="n">synchrony</span> <span class="k">do</span>
  <span class="n">data</span> <span class="o">=</span> <span class="sx">%w(data from the previous slide)</span> 
  <span class="n">db</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">Synchrony</span><span class="o">::</span><span class="no">ConnectionPool</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="mi">4</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">EM</span><span class="o">::</span><span class="no">MySQL</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="no">EM</span><span class="o">::</span><span class="no">Synchrony</span><span class="o">::</span><span class="no">Iterator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="p">,</span> <span class="n">iter</span><span class="o">|</span>
    <span class="n">db</span><span class="o">.</span><span class="n">aquery</span><span class="p">(</span><span class="s2">&quot;INSERT INTO table (data) VALUES(</span><span class="si">#{</span><span class="n">page</span><span class="si">}</span><span class="s2">);&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span> <span class="n">iter</span><span class="o">.</span><span class="n">return</span><span class="p">(</span><span class="n">http</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></p>

            </section>
            <section id="slide-3-3" class="">
              <h1>Back to Goliath</h1>

<p><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;goliath&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;em-synchrony/em-http&#39;</span>

<span class="k">class</span> <span class="nc">HelloWorld</span> <span class="o">&lt;</span> <span class="no">Goliath</span><span class="o">::</span><span class="no">API</span>
  <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="no">HR</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span>
    <span class="n">req</span> <span class="o">=</span> <span class="no">HR</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;http://www.google.com/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">response</span>
    <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{},</span> <span class="n">resp</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></p>

            </section>
        </section>
        <section id="section-4">
            <section id="slide-4-0" class="">
              <h1>More demo</h1>

            </section>
            <section id="slide-4-1" class="">
              <h1>What I didn't say</h1>

<ul>
<li>Several environments: dev / test / prod</li>
<li>Config per environment</li>
<li>A <code>runner</code> with options</li>
<li>Come with some convenient middlewares</li>
<li>Works with MRI / JRuby / Rubinius</li>
<li>...</li>
</ul>

            </section>
            <section id="slide-4-2" class="">
              <h1>Goliath</h1>

<p>It's time to conclude</p>

            </section>
        </section>
        <section id="section-5">
            <section id="slide-5-0" class="">
              <h1>That's all folks</h1>

<h2>Questions?</h2>

<ul>
<li>Slides on <a href="http://github.com/nono/Presentations">github.com/nono/Presentations</a></li>
<li>Demo on <a href="http://github.com/nono/demo-rulu">github.com/nono/demo-rulu</a></li>
<li>Rate me on <a href="http://speakerrate.com/talks/7854">speakerrate.com/talks/7854</a></li>
</ul>

            </section>
        </section>
    </div>
      <script src="../js/slideshow.js"></script>
  </body>
</html>
